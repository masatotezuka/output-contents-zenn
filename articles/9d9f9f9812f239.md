---
title: "ã€ReactÃ—Expressã€‘ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã§SPAã®èªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã¿ãŸã€‚"
emoji: "ğŸŒ±"
type: "tech"
topics:
  - "react"
  - "typescript"
  - "redux"
  - "express"
  - "typeorm"
published: true
published_at: "2022-07-20 14:46"
---

# ã¯ã˜ã‚ã«
JSON Web Tokenï¼ˆJWTï¼‰ã‚’ä½¿ç”¨ã—ãŸSPAã§ã®èªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã¿ãŸã®ã§ã€å­¦ã³ãŒã‚ã£ãŸã®ã§è¨˜äº‹ã«ã—ã¾ã—ãŸã€‚
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’åŒ…æ‹¬çš„ã«ã¾ã¨ã‚ãŸè¨˜äº‹ã¯å°‘ãªã‹ã£ãŸã®ã§ã€ã“ã®è¨˜äº‹ã‚’ã¿ã‚Œã°SPAã§èªè¨¼ã§ãã‚‹ã‚ˆã†ãªè¨˜äº‹ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

å®Ÿè£…ã§æ„è­˜ã—ãŸç‚¹ã¯ä»¥ä¸‹ã®3ç‚¹ã§ã™ã€‚
ãƒ»JWTã‚’localStorageã«ä¿å­˜ã™ã‚‹ã¨ã€XSSãŒèµ·ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ã§JWTã¯cookieã«ä¿å­˜
ãƒ»ãƒšãƒ¼ã‚¸ç§»å‹•ãƒ»ãƒ­ãƒ¼ãƒ‰ã”ã¨ã«ã‚µãƒ¼ãƒãƒ¼å´ã§èªè¨¼ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã®ãƒ•ãƒƒã‚¯ï¼ˆuseAuthï¼‰ã‚’ä½œæˆ
ãƒ»ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®æœ‰ç„¡ã«ã‚ˆã£ã¦ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’åˆ¶å¾¡ï¼ˆãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã—ã¦ã„ãªã„ã¨ãã«ã€èªè¨¼å¾Œã®ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã¯èªè¨¼å‰ã«ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã™ã‚‹ï¼‰

# å¯¾è±¡ã¨ãªã‚‹èª­è€…
ã“ã®è¨˜äº‹ã¯ä¸‹è¨˜ã‚ˆã†ãªäººã‚’å¯¾è±¡ã¨ã—ã¦æ›¸ã„ã¦ã„ã¾ã™ã€‚
- ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°åˆå¿ƒè€…
- é§†ã‘å‡ºã—ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- SPAã§èªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’çŸ¥ã‚ŠãŸã„äºº

# é–‹ç™ºç’°å¢ƒ
- **OS**
	- macOS Monterey v12.3.1
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**
	- è¨€èªï¼š TypeScript
	- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ï¼š React+Reactãƒ»Redux-toolkit
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**
	- è¨€èªï¼š Node.js+TypeScript
	- ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼š Express
	- DBï¼šPostgereSQL
	- ORM: TypeORM

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…
## ç’°å¢ƒæ§‹ç¯‰
Node.jsã§ç’°å¢ƒæ§‹ç¯‰ã§ãã‚‹å‰æã§é€²ã‚ã¾ã™ã®ã§ã€ã¾ã ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãªã„æ–¹ã¯ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
https://www.sejuku.net/blog/72545

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹ç¯‰
ã¾ãšã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
ãã®å¾Œã«ã€CLIã‚’ä½¿ç”¨ã—ã¦ã€TypeORMã«å¿…è¦ãªãƒ•ã‚©ãƒ«ãƒ€ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```
$ mkdir auth-app

$ cd auth-app

npmã®åˆæœŸåŒ–å‡¦ç†ã‚’ã™ã‚‹ã€‚
package.jsonãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¹ããƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ç¯„å›²ãŒè¨˜è¼‰ã•ã‚Œã‚‹ï¼‰
$ npm init 

å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒ¼ãƒ«
$ npm install express typeorm pg concurrently bcrypt dotenv jsonwebtoken ms cookie-parser cors

é–‹ç™ºç’°å¢ƒã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ npm install --save-dev typescript ts-node-dev @types/express @types/cors 

CLIã§DBã‚’postgreSQLã«æŒ‡å®šã—ã¦ã€TypeORMã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
npx typeorm init --database postgres
```

### PostgreSQLã®è¨­å®š
æ¬¡ã«ã€PostgreSQLã®è¨­å®šã‚’ã—ã¾ã™ã€‚
```
PostgeSQLã®èµ·å‹•
$ brew services start postgresql;

PostgeSQLã¸ã®æ¥ç¶š
$ psql

ãƒ­ãƒ¼ãƒ«ã®ä½œæˆ
$ CREATE USER my_dev

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ
$ CREATE DATABASE auth_app_development OWNER my_dev;

æ¥ç¶šåœæ­¢
$ \q
```

## ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å®šç¾©
ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç®±ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ç†è§£ã—ã¦ã„ã¾ã™ã€‚
ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å®šç¾©ã§ã€ãƒ—ãƒ©ã‚¤ãƒãƒªã‚­ãƒ¼ã¨å¤–éƒ¨ã‚­ãƒ¼ã®æŒ‡å®šãƒ»ã‚«ãƒ©ãƒ åã®è¨­å®šãƒ»ã‚«ãƒ©ãƒ ã®å‹å®šç¾©ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã‚’ã—ã¾ã™ã€‚

```ts:src/entity/User.ts
import {
  Entity,
  PrimaryGeneratedColumn,
  Column,
  CreateDateColumn,
  UpdateDateColumn,
} from "typeorm";

//Userã‚¯ãƒ©ã‚¹ã‚’ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨æŒ‡å®šã™ã‚‹
@Entity()
export class User {
//ãƒ—ãƒ©ã‚¤ãƒãƒªã‚­ãƒ¼ãŒè‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  firstName: string;

  @Column()
  lastName: string;

  @Column()
  mail: string;

  @Column()
  password: string;

//ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ä½œæˆæ—¥ãŒè‡ªå‹•ã§æŒ¿å…¥ã•ã‚Œã‚‹ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼
  @CreateDateColumn()
  createdAt: Date;

//ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°æ—¥ãŒè‡ªå‹•ã§æŒ¿å…¥ã•ã‚Œã‚‹ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼
  @UpdateDateColumn()
  updatedAt: Date;
}
```

## data-source.tsãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š
srcãƒ•ã‚©ãƒ«ãƒ€ä¸‹ã§ã¯data-source.tsãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ããªã‹ã£ãŸã®ã§ã€ã¾ãšdata-source.tsãƒ•ã‚¡ã‚¤ãƒ«ã‚’auth-appãƒ•ã‚©ãƒ«ãƒ€ä¸‹ã«ç§»å‹•ã•ã›ã¾ã™ã€‚

DataSourceã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®æ¥ç¶šãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
DataSourceã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®šã•ã‚Œã¦ã„ã¾ã™ãŒã€ã€Œusernameã€ã€Œpasswordã€ã€Œentitiesã€ã€Œmigrationsã€ãªã©ä¸€éƒ¨ä¿®æ­£ã—ã¾ã™ã€‚

```ts:data-source.ts
import "reflect-metadata";
import { DataSource } from "typeorm";

//DataSourceã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
//DataSourceã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
export const AppDataSource = new DataSource({
  type: "postgres",
  host: "localhost",
  port: 5432,
  username: "my_dev",
  password: undefined,
  database: "auth_app_development",
  synchronize: true,
  logging: false,
  entities: ["../src/entity/*.ts"],
  migrations: ["../src/migration/*.ts"],
  subscribers: [],
});

```

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
ã“ã“ã§ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã¯ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å®šç¾©ã‚’ã‚‚ã¨ã«DBã§ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚’ã™ã‚‹ã“ã¨ã§ã™ã€‚
npmã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œã«å¿…è¦ãªã‚³ãƒ¼ãƒ‰ã‚’ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€šã‚Šã«æ›¸ãã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã®ã§ä¸‹è¨˜ã®issueã‚’å‚è€ƒã«ã—ã¦æ›¸ãã¾ã—ãŸã€‚
https://github.com/typeorm/typeorm/issues/8810

```diff json:package.json
{
  "name": "auth-app",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "start": "ts-node src/index.ts",
+    "typeorm": "ts-node-dev  ./node_modules/typeorm/cli.js -d data-source.ts",
+    "migration:generate": "npm run typeorm migration:generate",
+    "migration:show": "npm run typeorm migration:show",
+    "migration:run": "npm run typeorm migration:run",
+    "migration:revert": "npm run typeorm migration:revert",
+    "migration:create": "typeorm-ts-node-commonjs migration:create"
  },

  //ä»¥ä¸‹ç•¥
```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
```
$ npm run migration:generate src/migration/init
```

ã²ã¨ã¾ãšã€ç’°å¢ƒæ§‹ç¯‰ãƒ»TypeORMã®è¨­å®šã¯ã“ã‚Œã§çµ‚äº†ã§ã™ã€‚


## ã‚µãƒ¼ãƒãƒ¼èµ·å‹•

æ¬¡ã«ã€Expressã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚’ã—ã¾ã™ã€‚
ã•ã‚‰ã«ã€ä»Šå›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å¿…è¦ãªãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚‚è¨­å®šã—ã¾ã™ã€‚

ã“ã“ã§ã€CORSï¼ˆCross-origin resource sharingï¼‰ã«ã¤ã„ã¦å°‘ã—è§£èª¬ã—ã¾ã™ã€‚CORSã®Oã€ã¤ã¾ã‚Šoriginã¨ã¯ã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒ»ãƒ›ã‚¹ãƒˆãƒ»ãƒãƒ¼ãƒˆã®3ã¤ã®éƒ¨åˆ†ã§å®šç¾©ã•ã‚Œã¾ã™ã€‚é€šå¸¸ã€åŒä¸€ã®originåŒå£«ã§ã—ã‹ãƒªã‚½ãƒ¼ã‚¹å…±æœ‰ï¼ˆæƒ…å ±é€šä¿¡ï¼‰ã¯ã§ãã¾ã›ã‚“ãŒã€CORSã¯ç•°ãªã‚‹ã‚ªãƒªã‚¸ãƒ³é–“ã§ãƒªã‚½ãƒ¼ã‚¹å…±æœ‰ã§ãã‚‹ã“ã¨ã‚’ã„ã„ã¾ã™ã€‚ä»Šå›ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ãã‚Œãã‚Œåˆ¥ã®ãƒãƒ¼ãƒˆç•ªå·ã§ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã®ã§CORSã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
CORSã«ã¤ã„ã¦ã¯ã“ã¡ã‚‰ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚
https://qiita.com/att55/items/2154a8aad8bf1409db2b

```ts:src/index.ts
import { AppDataSource } from "../data-source";
import * as cors from "cors";
import * as dotenv from "dotenv";
import * as cookieParser from "cookie-parser";
import * as express from "express";

dotenv.config();
const app = express();

const corsOptions: cors.CorsOptions = {
  //ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã®ãƒãƒ¼ãƒˆç•ªå·ã‚’è¨­å®šã™ã‚‹
  origin: "http://localhost:3000",
  //èªè¨¼æƒ…å ±ã®é€šä¿¡ã‚’ã™ã‚‹ãŸã‚ã«trueã«ã™ã‚‹
  credentials: false,
};

//3000ç•ªãƒãƒ¼ãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯
app.use(cors(corsOptions));
//URLã®ãªã‹ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—ã‚’èª­ã¿å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
app.use(express.urlencoded({ extended: true }));
//ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
app.use(express.json());
//ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸcookieã‚’èª­ã¿å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
app.use(cookieParser());

AppDataSource.initialize()
  .then(() => {
    console.log("Data Source has been initialized!");
  })
  .catch((err) => {
    console.error("Error during Data Source initialization:", err);
  });

app.listen(8000);
```

## JWTã®è¨­å®š
MVCã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®èªè¨¼æ–¹å¼ãŒä¸€èˆ¬çš„ã§ã™ãŒã€SPA(Single Page Application)ã§ã¯ä¸€èˆ¬çš„ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”¨ã„ãŸèªè¨¼æ–¹å¼ãŒç”¨ã„ã‚‰ã‚Œã¾ã™ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®DBã«ä¿å­˜ã—ã¦ç®¡ç†ã—ã¦ã„ã¾ã™ãŒã€ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãã—ã¦ã€ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã—ã¦ã‚ˆãä½¿ã‚ã‚Œã‚‹ã®ãŒJWTã§ã™ã€‚ã“ã“ã§ã¯è©³ã—ã„èª¬æ˜ã¯çœç•¥ã—ã¾ã™ãŒã€JWTã¨ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆheaderï¼‰ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼ˆpayloadï¼‰ã€ç½²åï¼ˆsignatureï¼‰ã®ï¼“ã¤ã®éƒ¨åˆ†ã§æ§‹æˆã•ã‚Œã„ã¦ã€JSONãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§è¡¨ç¾ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã§ã™ã€‚èªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ä¸Šã§ã€JWTã®ç”Ÿæˆã¨æ¤œè¨¼ãŒå¿…è¦ãªã®ã§ã€jsonwebtokenã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚
https://www.npmjs.com/package/jsonwebtoken

ä»Šå›ã¯ã€jwtHelperã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¦ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®éƒ¨åˆ†ã§ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
```ts:src/helper/jwtHelepr.ts
import * as jwt from "jsonwebtoken";

export class jwtHelper {
//ç§˜å¯†éµ
  static jweSecret = "secret123";
  static createToken() {
    const token = jwt.sign({ foo: "bar" }, this.jweSecret, {
      expiresIn: "30d",
    });
    return token;
  }
  static verifyToken(token: string) {
    try {
      const decoded = jwt.verify(token, this.jweSecret);
      return decoded;
    } catch (err) {
      console.log(err);
    }
  }
}
```

## ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ã™ã‚‹ãŸã‚ã«ã€srcãƒ•ã‚©ãƒ«ãƒ€ä¸‹ã«routerãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ã€ãã®ãƒ•ã‚©ãƒ«ãƒ€ä¸‹ã«å¿…è¦ãªãƒ•ã‚©ãƒ«ãƒ€ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
ä»Šå›ã¯routerãƒ•ã‚©ãƒ«ãƒ€ä¸‹ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚‚å…¥ã‚Œã‚“ã“ã‚“ã å½¢ã«ã—ã¾ã™ã€‚
```
src
  â”œã€€router
  â”‚   â”œ home
  â”‚   â”‚   â””index.ts
  â”‚   â”œ login
  â”‚   â”‚   â””index.ts
  â”‚   â”œ logout
  â”‚   â”‚   â””index.ts
  â”‚   â”œ signUp
  â”‚   â”‚   â””index.ts
  â”‚   â”œ index.ts
//ä»¥ä¸‹ç•¥
```

ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ã—ã¾ã™ã€‚
```ts:src/router/index.ts
import * as express from "express";
import login from "./login";
import signUp from "./signUp";
import logout from "./logout";
import home from "./home";

const router = express.Router();

//èªè¨¼å‰ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
router.use("/sign-up", signUp);
router.use("/login", login);
router.use("/logout", logout);

//jwtãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼
router.get("/tokenVerification", (req, res, next) => {
  let token = "";
  if (req.cookies.jwtToken) {
    token = req.cookies.jwtToken;
  } else {
    //cookieã«jwtãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã¯ã€èªè¨¼ä¸å¯
    return res.status(200).json({ isAuthenticated: false });
  }

  //  ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸjwtãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
  const decode = jwtHelper.verifyToken(token);
  if (decode) {
    //æ¤œè¨¼ãŒOKã§ã‚ã‚Œã°ã€jwtãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†ä½œæˆ
    const token = jwtHelper.createToken();
    res.cookie("jwtToken", token, {
      httpOnly: true,
      expires: new Date(Date.now() + ms("2d")),
    });
    res.status(200).json({ isAuthenticated: true });
  }
});

//èªè¨¼å¾Œãƒšãƒ¼ã‚¸ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
router.use("/home", home);

export default router;
```

## ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®šç¾©
ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§èª­ã¿è¾¼ã‚“ã§ã„ã‚‹å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚

### ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—

```ts:src/router/signUp/index.ts
import * as express from "express";
import { User } from "../../entity/User";
import { AppDataSource } from "../../../data-source";
import * as bcrypt from "bcrypt";
import ms = require("ms");
import { jwtHelper } from "../../helper/jwtHelper";

const router = express.Router();
const userRepository = AppDataSource.getRepository(User);

router.post("/", async (req, res, next) => {
  try {
    const user = await userRepository.findOne({
      where: { mail: req.body.email },
    });

    if (user) {
      throw new Error("USERS_ALREADY_EXISTS_USER");
    }
    //ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–
    const hashPassword = await bcrypt.hash(req.body.password, 10);
    if (!hashPassword) {
      throw new Error("SERVER_ERROR");
    }

    //DBã«ä¿å­˜
    await userRepository.insert({
      firstName: req.body.firstName,
      lastName: req.body.lastName,
      mail: req.body.email,
      password: hashPassword,
    });

    //jwtãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
    const jwtToken = jwtHelper.createToken();

    return res.status(200).cookie("jwtToken", jwtToken, {
      httpOnly: true,
      //ãƒˆãƒ¼ã‚¯ãƒ³ã®æœŸé™ã‚’è¨­å®š
      expires: new Date(Date.now() + ms("2d")),
    });
  } catch (error) {
    console.log(error);
  }
});

export default router;
```

### ãƒ­ã‚°ã‚¤ãƒ³
```ts:src/router/login/index.ts
import * as express from "express";
import { AppDataSource } from "../../../data-source";
import { User } from "../../entity/User";
import * as bcrypt from "bcrypt";
import { jwtHelper } from "../../helper/jwtHelper";
import ms = require("ms");

const router = express.Router();
//ãƒ¬ãƒã‚¸ãƒˆãƒªã‚’å–å¾—ï¼ˆãƒ‡ãƒ¼ã‚¿ã®æ ¼ç´å…ˆã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æŒ‡å®šã™ã‚‹ï¼‰
const userRepository = AppDataSource.getRepository(User);
router.post("/", async (req, res, next) => {
  try {
    const user = req.body;

    if (!user.email || !user.password) {
      throw new Error("USERS_INVALID_VALUE");
    }

    //DBã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const result = await userRepository.findOne({
      where: { mail: user.email },
    });

    //æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ãƒã‚§ãƒƒã‚¯
    if (!result) {
      throw new Error("USERS_NOT_EXISTS_USER");
    }

    //ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨DBã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæš—å·åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ã‚’æ¯”è¼ƒ
    const match = await bcrypt.compare(user.password, result.password);
    if (match) {
      //ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒåŒã˜ã®å ´åˆã€jsonWebTokenã‚’ä½œæˆ
      const jwtToken = jwtHelper.createToken();
      res
        .cookie("jwtToken", jwtToken, {
          //webã‚µãƒ¼ãƒãƒ¼ã®ã¿ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
          httpOnly: true,
          //cookieã®æœ‰åŠ¹æœŸé™ã¯2æ—¥é–“ã«è¨­å®š
          expires: new Date(Date.now() + ms("2d")),
        })
        .json({
          user: {
            id: result.id,
          },
        });
    } else {
      throw new Error("SERVER_ERROR");
    }
  } catch (error) {
    if (error instanceof Error) {
      console.log(error.message);
    }
  }
});

export default router;
```

### ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
```ts:src/router/logout/index.ts
import * as express from "express";
import ms = require("ms");

const router = express.Router();

router.post("/", (req, res, next) => {
  try {
    return res.status(200).cookie("jwtToken", "", {
      httpOnly: true,
      expires: new Date(Date.now() + ms("1d")),
    });
  } catch (error) {
    console.log(error);
  }
});

export default router;
```

### ãƒ­ã‚°ã‚¤ãƒ³å¾Œ
```ts:src/router/home/index.ts
import * as express from "express";

const router = express.Router();

router.get("/", (req, res, next) => {
  res.send("SUCCESS");
});

export default router;
```

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…ã¯ã“ã‚Œã§å®Œäº†ã§ã™ã€‚
æ¬¡ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…ã‚’ã—ã¦ã„ãã¾ã™ã€‚

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…

## ç’°å¢ƒæ§‹ç¯‰

ã€ŒCreate-React-Appã€ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
https://create-react-app.dev/docs/getting-started/
```
$ npx create-react-app@5.0.1 frontend --template typescript

$ npm i react-router-dom axios 
```


ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¸¡æ–¹ã®ã‚µãƒ¼ãƒãƒ¼ã‚’åŒæ™‚ã«ç«‹ã¡ä¸Šã’ã‚‹ãŸã‚ã«ã€concurrentlyã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã®package.jsonã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff json:package.json
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "start": "ts-node src/index.ts",
+   "serve": "ts-node-dev --respawn  src/index.ts --ignore-watch ./frontend",
+   "dev": "concurrently \"npm run serve\" \"cd frontend && npm start\"",
    "typeorm": "ts-node-dev  ./node_modules/typeorm/cli.js -d data-source.ts",
    "migration:generate": "npm run typeorm migration:generate",
    "migration:show": "npm run typeorm migration:show",
    "migration:run": "npm run typeorm migration:run",
    "migration:revert": "npm run typeorm migration:revert",
    "migration:create": "typeorm-ts-node-commonjs migration:create"
  },
```

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã€Œnpm run devã€ã‚’èµ°ã‚‰ã›ã‚‹ã¨ã€3000ç•ªãƒãƒ¼ãƒˆã¨8000ç•ªãƒãƒ¼ãƒˆãŒåŒæ™‚ã«ç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚


## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ•´ç†
ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ãŸã‚Šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ•´ç†ã—ã¦ã„ãã€srcä¸‹ã‚’ä¸‹è¨˜ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã«ã—ã¾ã™ã€‚
```
frontend
 â””â”€â”€ src
ã€€ã€€ã€€ã€€  ã€€ã€€ã€€â”œâ”€api
 ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€â”œâ”€â”€components
     ã€€â”‚	 â”œâ”€â”€ErrorBoundary
    ã€€ã€€ã€€â”‚  ã€€â””â”€â”€pages
    ã€€ã€€ã€€â”‚  ã€€ã€€ã€€ã€€ã€€ã€€ã€€â”œâ”€â”€HomePage
   ã€€ã€€ã€€ â”‚ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€â”œâ”€â”€LoginPage
ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€â”‚ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€â”œâ”€â”€SignUpPage
 ã€€ã€€ ã€€  â”‚     ã€€â””â”€â”€TopPage
   ã€€ã€€ã€€ â”œâ”€â”€hooks
  ã€€   â”œâ”€â”€ App.tsx
   ã€€ã€€ã€€ â””â”€â”€index.tsx
```

## å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ä½¿ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
$ npm install react-hook-form react-router-dom axios
```

[react-hook-form](https://react-hook-form.com/jp/)ãƒ»ãƒ»ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã™ã‚‹ã¨ãã«ä½¿ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
[react-router-dom](https://reactrouter.com/)ãƒ»ãƒ»ãƒ»ãƒšãƒ¼ã‚¸é–“ã®ç§»å‹•ã«ä½¿ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¡Œã†ã€‚
[axios](https://github.com/axios/axios)ãƒ»ãƒ»ãƒ»HTTPé€šä¿¡ï¼ˆãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ãƒ»å–å¾—ï¼‰ã‚’ç°¡å˜ã«è¡Œã†ã“ã¨ãŒã§ãã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚


## APIã®ä½œæˆ
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒãƒ¼ãƒˆï¼ˆ8000ç•ªãƒãƒ¼ãƒˆï¼‰ã¨ãƒ‡ãƒ¼ã‚¿ã®ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹ãŸã‚ã«ã€axiosã‚’ä½¿ç”¨ã—ã¦å¿…è¦ãªAPIã‚’ä½œæˆã—ã¾ã™ã€‚

```tsx:src/api/index.ts
import axios from "axios";
axios.defaults.withCredentials = true;

export type User = {
  id?: number;
  firstName?: string;
  lastName?: string;
  mail: string;
  password?: string;
};

export const signUp = async (data: User) => {
  await axios.post("http://localhost:8000/sign-up", data);
  return;
};

export const login = async (data: User) => {
  await axios.post("http://localhost:8000/login", data);
  return;
};

export const logout = async () => {
  await axios.post("http://localhost:8000/logout");
  return;
};

//jwtã®æ¤œè¨¼
export const checkJwt = async () => {
  const response = axios.get("http://localhost:8000/tokenVerification");
  return response;
};
```

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½œæˆ
æ¬¡ã«æç”»ã™ã‚‹ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚ï¼ˆã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã¯çœç•¥ã•ã›ã¦ã„ãŸã ãã¾ã™ã®ã§ã€ç”»é¢ã¯å¤šå°‘ã¿ã«ãã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ï¼‰

### ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
react-router-domã®Linkã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã€ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®ç§»å‹•å…ˆã®URLã‚’æŒ‡å®šã—ã¾ã™ã€‚
ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯å¾Œã»ã©å®Ÿè£…ã—ã¾ã™ã€‚
```tsx:frontend/src/components/pages/TopPage/index.tsx
import { Link } from "react-router-dom";

export const TopPage = () => {
  return (
    <div>
      <Link to={"/sign-up"}>ç™»éŒ²</Link>
      <Link to={"/login"}>ãƒ­ã‚°ã‚¤ãƒ³</Link>
    </div>
  );
};
```
è¡¨ç¤ºç”»é¢
![](https://storage.googleapis.com/zenn-user-upload/e05ba516faee-20220724.png)

### ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸
ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æƒ…å ±ã‚’é€ä¿¡ã™ã‚‹ã¨ãã«ã€react-hook-formã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
è©³ã—ã„å®Ÿè£…æ–¹æ³•ã¯ã“ã¡ã‚‰ã‚’ã”è¦§ãã ã•ã„ã€‚
https://react-hook-form.com/jp/get-started

```tsx:frontend/src/components/pages/SignUpPage/index.tsx
import { useForm, SubmitHandler } from "react-hook-form";
import { useNavigate } from "react-router-dom";
import { signUp, User } from "../../../api/index";

export const SignUpPage = () => {
  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<User>();
  const navigate = useNavigate();

  const onSubmit: SubmitHandler<User> = async (data) => {
    await signUp(data);
    //èªè¨¼å¾Œã®ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    navigate("/home");
  };
  return (
    <div>
      <form onSubmit={handleSubmit(onSubmit)}>
        <label htmlFor="firstName">
          æ€§
          <input
            id="firstName"
            type="text"
            {...register("firstName", { required: true })}
          />
        </label>
        <p> {errors.firstName && "æ–‡å­—ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“"}</p>
        <label htmlFor="lastName">å</label>
        <input
          id="lastName"
          type="text"
          {...register("lastName", { required: true })}
        />
        <p> {errors.lastName && "æ–‡å­—ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“"}</p>
        <label htmlFor="email_register">Eãƒ¡ãƒ¼ãƒ«</label>
        <input
          id="email_register"
          type="email"
          {...register("mail", { required: true })}
        />
        <p> {errors.mail && "æ–‡å­—ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“"}</p>
        <label htmlFor="password_register">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input
          id="password_register"
          type="password"
          {...register("password", { required: true })}
        />
        <p> {errors.password && "æ–‡å­—ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“"}</p>
        <button type="submit">æ–°è¦ç™»éŒ²</button>
      </form>
    </div>
  );
};
```
è¡¨ç¤ºç”»é¢
![](https://storage.googleapis.com/zenn-user-upload/9cb60319256a-20220724.png)


### ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
```tsx:frontend/src/components/pages/LoginPage/index.tsx
import React from "react";
import { useForm, SubmitHandler } from "react-hook-form";
import { useNavigate } from "react-router-dom";
import { User, login } from "../../../api/index";

export const LoginPage = () => {
  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<User>();
  const navigate = useNavigate();

  const onSubmit: SubmitHandler<User> = async (data) => {
    await login(data);
    //èªè¨¼å¾Œã®ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    navigate("/home");
  };

  return (
    <div>
      <form onSubmit={handleSubmit(onSubmit)}>
        <label htmlFor="email_register">Eãƒ¡ãƒ¼ãƒ«</label>
        <input
          id="email_register"
          type="email"
          {...register("mail", { required: true })}
        />
        <p> {errors.mail && "æ–‡å­—ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“"}</p>
        <label htmlFor="password_register">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input
          id="password_register"
          type="password"
          {...register("password", { required: true })}
        />
        <p> {errors.password && "æ–‡å­—ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“"}</p>
        <button type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </form>
    </div>
  );
};
```
è¡¨ç¤ºç”»é¢
![](https://storage.googleapis.com/zenn-user-upload/5a5fc16605fc-20220724.png)


### èªè¨¼å¾Œã®ãƒšãƒ¼ã‚¸
```tsx:frontend/src/components/pages/HomePage/index.tsx
import React from "react";
import { useNavigate } from "react-router-dom";
import { logout } from "../../../api";
export const HomePage = () => {
  const navigate = useNavigate();
  const handleLogout = async () => {
    console.log("logout");

    await logout();
    navigate("/");
  };

  return (
    <div>
      <p>ãƒ­ã‚°ã‚¤ãƒ³ä¸­</p>
      <button onClick={() => handleLogout()}>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  );
};

```
è¡¨ç¤ºç”»é¢
![](https://storage.googleapis.com/zenn-user-upload/23bdd05187f0-20220724.png)

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æç”»
ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å†…å®¹ã‚’æç”»ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

#### å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®èª¬æ˜
**ãƒ»ErrorBoundaryã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**
äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã¨ãã«æç”»ã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯ã‚³ãƒ¼ãƒ‰ã¯çœç•¥ã—ã¾ã™ãŒã€ãƒšãƒ¼ã‚¸æœ€ä¸‹éƒ¨ã«git hubã‚’æ·»ä»˜ã—ã¦ãŠã‚Šã¾ã™ã®ã§ãã¡ã‚‰ã‚ˆã‚Šã”ç¢ºèªãã ã•ã„ã€‚

**ãƒ»React.StrictModeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**
[å…¬å¼](https://ja.reactjs.org/docs/strict-mode.html)ã«ã‚ˆã‚‹ã¨ã€StrictModeã¯ä¸‹è¨˜ã®æ©Ÿèƒ½ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚
>å®‰å…¨ã§ãªã„ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã®ç‰¹å®š
>ãƒ¬ã‚¬ã‚·ãƒ¼ãªæ–‡å­—åˆ— ref API ã®ä½¿ç”¨ã«å¯¾ã™ã‚‹è­¦å‘Š
>éæ¨å¥¨ãª findDOMNode ã®ä½¿ç”¨ã«å¯¾ã™ã‚‹è­¦å‘Š
>æ„å›³ã—ãªã„å‰¯ä½œç”¨ã®æ¤œå‡º
>ãƒ¬ã‚¬ã‚·ãƒ¼ãªã‚³ãƒ³ãƒ†ã‚¯ã‚¹ãƒˆ API ã®æ¤œå‡º
>state ã®å†åˆ©ç”¨æ€§ã‚’ä¿è¨¼ã™ã‚‹

**ãƒ»BrowserRouterã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**
<BrowserRouter/>ã¯ã€HTML5ã®Hisory APIï¼ˆpushstateã€replacestateã€popstateã‚¤ãƒ™ãƒ³ãƒˆï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€UIã‚’URLã¨åŒæœŸã•ã›ã¾ã™ã€‚<App/>ã§react-dom-routerã®<Routes/>ã‚„<Route/>ã‚’ä½¿ç”¨ã—ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šã‚’ã—ã¾ã™ãŒã€<BrowserRouter/>ãŒãã‚Œã‚‰ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**ãƒ»Appã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**
ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šã‚’ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚å¾Œã»ã©èª¬æ˜ã—ã¾ã™ã€‚

```tsx:frontend/src/index.tsx
import React from "react";
import { createRoot } from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import { App } from "./App";
import ErrorBoundary from "./components/ErrorBoundary";

const container = document.getElementById("root")!;
const root = createRoot(container);


root.render(
  <ErrorBoundary>
    <React.StrictMode>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </React.StrictMode>
  </ErrorBoundary>
);
```

## èªè¨¼ã®ãŸã‚ã®ãƒ•ãƒƒã‚¯ã®å®Ÿè£…
ã“ã“ãŒä»Šå›ã®è‚ã‹ã¨æ€ã„ã¾ã™ã€‚
ãƒšãƒ¼ã‚¸ç§»å‹•ãƒ»ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸã¨ãã«ã€èªè¨¼ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ„ã¿è¾¼ã‚€ãŸã‚ã®ãƒ•ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```tsx:frontend/src/hooks/useAuth.ts
import { useState, useEffect } from "react";
import { checkJwt } from "../api";

export const useAuth = () => {
//èªè¨¼ã‚’è¨±å¯ã™ã‚‹ã‹ã©ã†ã‹ã‚’çŠ¶æ…‹ç®¡ç†
  const [check, setCheck] = useState<{
    checked: boolean;
    isAuthenticated: boolean;
  }>({ checked: false, isAuthenticated: false });
  //ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¾Œã«å®Ÿè¡Œ
  useEffect(() => {
    const handleCheckJwt = async () => {
      try {
      //ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§JWTã®æ¤œè¨¼ãŠã‚ˆã³å†ä½œæˆ
        const response = await checkJwt();
        setCheck({
          checked: true,
          isAuthenticated: response.data.isAuthenticated,
        });
      } catch (error) {
        setCheck({ checked: true, isAuthenticated: false });
      }
    };
    handleCheckJwt();
  }, []);

  return check;
};
```

## PrivateRouteã¨GuestRouteã®ä½œæˆ
èªè¨¼ãŒå¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã¯<PrivateRoute/>ã§ãƒ©ãƒƒãƒ—ã—ã¦ã€èªè¨¼ãŒä¸è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã¯<GuestRoute/>ã‚’ãƒ©ãƒƒãƒ—ã—ã¾ã™ã€‚
<GuestRoute/>ã¯ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§èªè¨¼å‰ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ãã«ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

**<PrivateRoute/>ã®ãƒ­ã‚¸ãƒƒã‚¯**
èªè¨¼ãŒè¨±å¯â†’å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
èªè¨¼ãŒä¸è¨±å¯â†’"/"ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**<GuestRoute/>ã®ãƒ­ã‚¸ãƒƒã‚¯**
èªè¨¼ãŒè¨±å¯â†’"/home"ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
èªè¨¼ãŒä¸è¨±å¯â†’å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

```tsx:frontend/src/AuthRouter.tsx
import { Navigate } from "react-router-dom";
import { useAuth } from "./hooks/useAuth";

type Props = {
  children: React.ReactNode;
};

export const PrivateRoute = ({ children }: Props) => {
  const check = useAuth();

  if (!check.checked) {
    return <div>Loading...</div>;
  }

  if (check.isAuthenticated) {
    return <>{children}</>;
  }

  return <Navigate to="/" />;
};

export const GuestRoute = (props: Props) => {
  const { children } = props;
  const check = useAuth();
  console.log(check);
  
  if (!check.checked) {
    return <div>Loading...</div>;
  }

  if (check.isAuthenticated) {
    return <Navigate to="/home" />;
  }

  return <>{children}</>;
};
```

## ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
æœ€å¾Œã«ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ã—ã¦å®Ÿè£…å®Œäº†ã§ã™ã€‚
ã¾ãšã€<Routes/>ã§è¤‡æ•°ã®<Route/>ã‚’ãƒ©ãƒƒãƒ—ã—ã¾ã™ã€‚
<Route/>ã®pathã«ä¸€è‡´ã—ãŸã¨ãã«æç”»ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŒ‡å®šã—ã¾ã™ã€‚
```tsx:frontend/src/App.tsx
import { Routes, Route } from "react-router-dom";
import { TopPage } from "./components/pages/TopPage";
import { HomePage } from "./components/pages/HomePage";
import { SignUpPage } from "./components/pages/SignUpPage";
import { LoginPage } from "./components/pages/LoginPage";
import { NotFoundPage } from "./components/pages/NotFoundPage";
import { GuestRoute, PrivateRoute } from "./AuthRouter";

export const App = () => {
  return (
    <>
      <Routes>
        <Route
          path="/"
	  //<GuestRoute/>ã§ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§ãªã‘ã‚Œã°å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆ<TopPage/>ï¼‰ãŒæç”»ã•ã‚Œã‚‹
          element={<GuestRoute children={<TopPage />}></GuestRoute>}
        />
        <Route
          path="/sign-up"
          element={<GuestRoute children={<SignUpPage />}></GuestRoute>}
        />
        <Route
          path="/login"
          element={<GuestRoute children={<LoginPage />}></GuestRoute>}
        />
        <Route
          path="/home"
          element={<PrivateRoute children={<HomePage />}></PrivateRoute>}
        />
        <Route path="*" element={<NotFoundPage />} />
      </Routes>
    </>
  );
};
```

æœ€å¾Œã«ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€checkã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®çŠ¶æ…‹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¦ã¿ã¾ã™ã€‚
checkã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ2å›å‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯å‰¯ä½œç”¨é–¢æ•°ã«ã‚ˆã‚Šãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®å‰å¾Œã§2å›useAuthãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚
1å›ç›®ã§ã¯èªè¨¼ã®ãƒã‚§ãƒƒã‚¯å‰ãªã®ã§ã€Œloading...ã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã€2å›ç›®ã§ã¯èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã‚‹ï¼ˆèªè¨¼ãŒä¸è¨±å¯ï¼‰ã®ã§ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/3459dec7349c-20220725.png)

# æœ€å¾Œã«
ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã«ã‚ˆã‚‹SPAã®èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…ã¯ä»¥ä¸Šãªã‚Šã¾ã™ã€‚
ã‚‚ã—èª¤ã‚ŠãŒã‚ã£ãŸã‚Šã€ã‚ˆã‚Šã‚ˆã„å®Ÿè£…æ–¹æ³•ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚


# å‚è€ƒè¨˜äº‹
https://www.sejuku.net/blog/72545

https://github.com/typeorm/typeorm/issues/8810

https://qiita.com/att55/items/2154a8aad8bf1409db2b

https://coders-shelf.com/react-auth-problem/

https://www.npmjs.com/package/jsonwebtoken

https://create-react-app.dev/docs/getting-started/

https://react-hook-form.com/jp/

https://reactrouter.com/

https://github.com/axios/axios

https://www.javatpoint.com/browserrouter-in-react

https://ja.reactjs.org/docs/strict-mode.html



